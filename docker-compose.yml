# ================================================
# model-finetune-tool Docker Compose 配置
# ================================================
# 使用方法:
#   1. 配置 .env 文件（OPENAI_API_KEY）
#   2. 准备 documents 目录
#   3. 运行: docker-compose up -d
# ================================================

version: '3.8'

services:
  finetune:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: model-finetune-tool
    image: model-finetune-tool:latest
    
    # 环境变量（敏感信息请使用 .env 文件）
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    
    # 挂载卷
    volumes:
      # 项目目录（只读）
      - .:/app:ro
      
      # 数据目录（读写）
      - ./data:/app/data
      
      # 输出目录（读写）
      - ./output:/app/output
      
      # 文档目录（读写）
      - ./documents:/app/documents
      
      # 模型缓存（持久化）
      - ./models:/root/.cache/huggingface
    
    # 工作目录
    working_dir: /app
    
    # 命令
    command: >
      sh -c "
        echo '可用命令: finetune --help' &&
        finetune --help
      "
    
    # 重启策略
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

# ================================================
# 使用示例
# ================================================
#
# 1. 创建 .env 文件:
#    echo "OPENAI_API_KEY=your-key" > .env
#
# 2. 准备文档:
#    mkdir -p documents && cp your-docs/*.md documents/
#
# 3. 启动服务:
#    docker-compose up -d
#
# 4. 进入容器:
#    docker-compose exec finetune bash
#
# 5. 运行命令:
#    finetune parse ./documents my_dataset
#
# 6. 查看日志:
#    docker-compose logs -f
#
# 7. 停止服务:
#    docker-compose down
# ================================================
